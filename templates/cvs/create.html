{% extends "layouts/base.html" %}

{% block title %}Upload CV - JobFit Analytics{% endblock %}

{% block content %}
<!-- CSRF Token -->
<meta name="csrf-token" content="{{ csrf_token() }}">
<!-- PDF.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                Upload New CV
            </h2>
            <p class="mt-1 text-sm text-gray-500">
                Upload one or multiple PDF CVs and let AI analyze them for you.
            </p>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <a href="{{ url_for('cvs_index') }}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Back to CVs
            </a>
        </div>
</div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
        <!-- Left Column: Upload & Info (40%) -->
        <div class="space-y-6 lg:col-span-2">
            <!-- File Upload Section -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Upload CV Files</h3>
                    <form method="POST" enctype="multipart/form-data" id="cvForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <!-- File Upload Area -->
                        <div class="mt-1 flex justify-center px-6 pt-8 pb-8 border-2 border-gray-300 border-dashed rounded-lg hover:border-primary-400 transition-colors" id="uploadArea">
                            <div class="space-y-1 text-center">
                                <i class="fas fa-cloud-upload-alt text-gray-400 text-5xl mb-4"></i>
                                <div class="flex text-sm text-gray-600">
                                    <label for="files" class="relative cursor-pointer bg-white rounded-md font-medium text-primary-600 hover:text-primary-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary-500">
                                        <span>Choose PDF files</span>
                                        <input id="files" name="files" type="file" accept=".pdf" multiple required class="sr-only">
                                    </label>
                                    <p class="pl-1">or drag and drop</p>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">PDF files only, up to 10MB each</p>
                                <p class="text-xs text-gray-400 mt-1" id="fileInfo">No files selected</p>
            </div>
                    </div>
                    
                        <!-- Selected Files List -->
                        <div id="selectedFilesList" class="mt-4 hidden">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Selected Files:</h4>
                            <div id="filesList" class="space-y-2 max-h-32 overflow-y-auto">
                                <!-- Files will be listed here -->
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="mt-6">
                            <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-upload mr-2"></i>Upload & Analyze CVs
                        </button>
                    </div>
                </form>
                </div>
            </div>

            <!-- AI Analysis Info -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-robot text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">AI-Powered Analysis</h3>
                        <div class="mt-2 text-sm text-blue-700">
                            <p>Our AI will automatically extract and analyze each CV:</p>
                            <ul class="list-disc list-inside mt-1 space-y-1 text-xs">
                                <li>Personal information</li>
                                <li>Education background</li>
                                <li>Work experience</li>
                                <li>Skills and competencies</li>
                                <li>Professional summary</li>
                            </ul>
                            <p class="mt-2 text-xs text-blue-600 font-medium">Multiple CVs will be processed in batch</p>
            </div>
            </div>
        </div>
    </div>
    
            <!-- AI Tips -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-lightbulb text-green-400"></i>
            </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-green-800">Tips for Best Results</h3>
                        <div class="mt-2 text-sm text-green-700">
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>Use clear, high-quality PDF files</li>
                                <li>Ensure text is selectable (not scanned images)</li>
                                <li>Include complete contact information</li>
                                <li>List all relevant work experience</li>
                                <li>Include education and certifications</li>
                                <li>Select multiple files at once for batch processing</li>
                </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Preview (60%) -->
        <div class="space-y-6 lg:col-span-3">
            <!-- CV Preview -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">CV Preview</h3>
                    
                    <!-- No File Selected State -->
                    <div id="noFilePreview" class="text-center py-12">
                        <i class="fas fa-file-pdf text-gray-300 text-6xl mb-4"></i>
                        <h4 class="text-lg font-medium text-gray-900 mb-2">No CV Selected</h4>
                        <p class="text-sm text-gray-500">Upload a PDF file to see preview</p>
                    </div>

                    <!-- File Preview State -->
                    <div id="filePreview" class="hidden">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <!-- File Navigation -->
                            <div id="fileNavigation" class="hidden mb-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <button id="prevFile" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-xs disabled:opacity-50 disabled:cursor-not-allowed">
                                            <i class="fas fa-chevron-left"></i> Prev
                                        </button>
                                        <span id="fileInfo" class="text-xs text-gray-600">File 1 of 1</span>
                                        <button id="nextFile" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-xs disabled:opacity-50 disabled:cursor-not-allowed">
                                            Next <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        <span id="currentFileIndex">1</span> of <span id="totalFiles">1</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center mb-4">
                                <i class="fas fa-file-pdf text-red-500 text-2xl mr-3"></i>
                                <div>
                                    <h4 class="text-sm font-medium text-gray-900" id="fileName">CV.pdf</h4>
                                    <p class="text-xs text-gray-500" id="fileSize">0 KB</p>
                                </div>
                            </div>
                            
                            <!-- PDF Preview -->
                            <div class="bg-gray-50 border border-gray-200 rounded-lg overflow-hidden">
                                <div id="pdfContainer" class="hidden">
                                    <div class="overflow-auto max-h-96">
                                        <canvas id="pdfCanvas" class="mx-auto block"></canvas>
                                    </div>
                                </div>
                                <div id="pdfPlaceholder" class="p-8 text-center">
                                    <i class="fas fa-file-pdf text-gray-400 text-4xl mb-2"></i>
                                    <p class="text-sm text-gray-500">PDF Preview</p>
                                    <p class="text-xs text-gray-400 mt-1">Select a PDF file to preview</p>
            </div>
        </div>
        
                            <!-- PDF Controls -->
                            <div id="pdfControls" class="hidden mt-3 flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <button id="prevPage" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-xs disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-chevron-left"></i> Prev
                                    </button>
                                    <span id="pageInfo" class="text-xs text-gray-600">Page 1 of 1</span>
                                    <button id="nextPage" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-xs disabled:opacity-50 disabled:cursor-not-allowed">
                                        Next <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button id="zoomOut" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded text-xs disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                    <span id="zoomLevel" class="text-xs text-gray-600">100%</span>
                                    <button id="zoomIn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded text-xs disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
            </div>
                </div>
            </div>
        </div>
    </div>
</div>

            <!-- Analysis Preview -->
            <!--
            <div class="bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">AI Analysis Preview</h3>
                    
                    <div id="filesOverview" class="hidden mb-6">
                        <h4 class="text-md font-medium text-gray-800 mb-3">Files Analysis Overview</h4>
                        <div id="filesOverviewList" class="space-y-2">
                        </div>
                    </div>
                    
                    <div id="analysisPreview" class="space-y-4 hidden">
                        <div class="text-center py-8">
                            <i class="fas fa-brain text-gray-300 text-4xl mb-3"></i>
                            <p class="text-sm text-gray-500">AI analysis will appear here after upload</p>
                        </div>
                    </div>
                </div>
            </div>
            -->
        </div>
    </div>
</div>

<script>
    // PDF.js configuration
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    // File upload handling
    const fileInput = document.getElementById('files');
    const uploadArea = document.getElementById('uploadArea');
    const noFilePreview = document.getElementById('noFilePreview');
    const filePreview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileInfo = document.getElementById('fileInfo');
    const selectedFilesList = document.getElementById('selectedFilesList');
    const filesList = document.getElementById('filesList');
    const filesOverview = document.getElementById('filesOverview');
    const filesOverviewList = document.getElementById('filesOverviewList');
    const fileNavigation = document.getElementById('fileNavigation');
    const prevFile = document.getElementById('prevFile');
    const nextFile = document.getElementById('nextFile');
    const fileCounter = document.getElementById('fileInfo');
    const fileInfoElement = document.getElementById('fileInfo');
    const currentFileIndexElement = document.getElementById('currentFileIndex');
    const totalFiles = document.getElementById('totalFiles');
    const pdfContainer = document.getElementById('pdfContainer');
    const pdfPlaceholder = document.getElementById('pdfPlaceholder');
    const pdfControls = document.getElementById('pdfControls');
    const pdfCanvas = document.getElementById('pdfCanvas');
    const pageInfo = document.getElementById('pageInfo');
    const zoomLevel = document.getElementById('zoomLevel');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const zoomIn = document.getElementById('zoomIn');
    const zoomOut = document.getElementById('zoomOut');

    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let scale = 1.0;
    let currentFileIndex = 0;
    let selectedFiles = [];
    let filesAnalysisResults = {}; // Store analysis results for each file

    fileInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        selectedFiles = files;
        currentFileIndex = 0;
        
        console.log('Files selected:', files.length, files);
        
        if (files.length > 0) {
            // Update upload area
            uploadArea.classList.remove('border-gray-300');
            uploadArea.classList.add('border-primary-400', 'bg-primary-50');
            
            const icon = uploadArea.querySelector('i');
            icon.classList.remove('fa-cloud-upload-alt', 'text-gray-400');
            icon.classList.add('fa-file-pdf', 'text-primary-500');
            
            const text = uploadArea.querySelector('span');
            if (files.length === 1) {
                text.textContent = files[0].name;
            } else {
                text.textContent = `${files.length} files selected`;
            }
            
            // Update file info
            const totalSize = files.reduce((sum, file) => sum + file.size, 0);
            fileInfo.textContent = `${files.length} file(s) selected (${formatFileSize(totalSize)})`;
            
            // Show selected files list
            displaySelectedFiles(files);
            
            // Show preview for first file
            if (files.length > 0) {
                console.log('Showing preview for files');
                noFilePreview.classList.add('hidden');
                filePreview.classList.remove('hidden');
                
                // Show/hide file navigation based on number of files
                if (files.length > 1) {
                    fileNavigation.classList.remove('hidden');
                    if (filesOverview) filesOverview.classList.remove('hidden');
                    updateFilesOverview();
                    
                    // Auto-analyze all files
                    analyzeAllFiles();
                } else {
                    fileNavigation.classList.add('hidden');
                    if (filesOverview) filesOverview.classList.add('hidden');
                    
                    // Auto-analyze single file
                    analyzeAllFiles();
                }
                
                // Update file navigation after setting up
                updateFileNavigation();
                
                // Load and preview first PDF
                loadCurrentFile();
            }
        } else {
            // Reset upload area
            uploadArea.classList.remove('border-primary-400', 'bg-primary-50');
            uploadArea.classList.add('border-gray-300');
            
            const icon = uploadArea.querySelector('i');
            icon.classList.remove('fa-file-pdf', 'text-primary-500');
            icon.classList.add('fa-cloud-upload-alt', 'text-gray-400');
            
            const text = uploadArea.querySelector('span');
            text.textContent = 'Choose PDF files';
            
            fileInfo.textContent = 'No files selected';
            
            // Hide preview and files list
            noFilePreview.classList.remove('hidden');
            filePreview.classList.add('hidden');
            selectedFilesList.classList.add('hidden');
            fileNavigation.classList.add('hidden');
            if (filesOverview) filesOverview.classList.add('hidden');
            pdfContainer.classList.add('hidden');
            pdfPlaceholder.classList.remove('hidden');
            pdfControls.classList.add('hidden');
            
            // Reset AI Analysis Preview
            resetAnalysisPreview();
            
            // Reset analysis results
            filesAnalysisResults = {};
        }
    });

    // Drag and drop handling
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('border-primary-400', 'bg-primary-50');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        if (!uploadArea.contains(e.relatedTarget)) {
            uploadArea.classList.remove('border-primary-400', 'bg-primary-50');
        }
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-primary-400', 'bg-primary-50');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            fileInput.dispatchEvent(new Event('change'));
        }
    });

    // Function to display selected files
    function displaySelectedFiles(files) {
        console.log('Displaying selected files:', files.length);
        selectedFilesList.classList.remove('hidden');
        filesList.innerHTML = '';
        
        files.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between p-2 bg-gray-50 rounded border';
            fileItem.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-file-pdf text-red-500 mr-2"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900">${file.name}</p>
                        <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
                    </div>
                </div>
                <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            filesList.appendChild(fileItem);
        });
        
        // Show analysis preview for first file with pending state
        if (files.length > 0) {
            showAnalysisPreview();
        }
    }

    // Function to remove a file from selection
    function removeFile(index) {
        console.log('Removing file at index:', index);
        const dt = new DataTransfer();
        const files = Array.from(fileInput.files);
        files.splice(index, 1);
        
        // Adjust current file index if needed
        if (index <= currentFileIndex && currentFileIndex > 0) {
            currentFileIndex--;
        } else if (index < currentFileIndex) {
            // No change needed
        } else if (currentFileIndex >= files.length && files.length > 0) {
            currentFileIndex = files.length - 1;
        }
        
        files.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
        fileInput.dispatchEvent(new Event('change'));
        
        // Hide analysis preview if no files left
        if (files.length === 0) {
            const analysisPreview = document.getElementById('analysisPreview');
            if (analysisPreview) analysisPreview.classList.add('hidden');
        }
    }

    // Function to load current file for preview
    function loadCurrentFile() {
        if (selectedFiles.length === 0) return;
        
        console.log('Loading current file:', currentFileIndex, selectedFiles.length);
        const currentFile = selectedFiles[currentFileIndex];
        console.log('Current file:', currentFile);
        fileName.textContent = currentFile.name;
        fileSize.textContent = formatFileSize(currentFile.size);
        
        // Load and preview PDF
        loadPDF(currentFile);
    }

    // Function to update file navigation UI
    function updateFileNavigation() {
        console.log('Updating file navigation:', selectedFiles.length, currentFileIndex);
        if (selectedFiles.length <= 1) {
            fileNavigation.classList.add('hidden');
            return;
        }
        
        fileCounter.textContent = `File ${currentFileIndex + 1} of ${selectedFiles.length}`;
        currentFileIndexElement.textContent = currentFileIndex + 1;
        totalFiles.textContent = selectedFiles.length;
        
        // Update navigation buttons
        prevFile.disabled = currentFileIndex === 0;
        nextFile.disabled = currentFileIndex === selectedFiles.length - 1;
        
        console.log('Navigation updated:', {
            fileInfo: fileInfoElement.textContent,
            currentFileIndex: currentFileIndexElement.textContent,
            totalFiles: totalFiles.textContent,
            prevDisabled: prevFile.disabled,
            nextDisabled: nextFile.disabled
        });
    }

    // Function to go to previous file
    function goToPreviousFile() {
        console.log('Going to previous file:', currentFileIndex);
        if (currentFileIndex > 0) {
            currentFileIndex--;
            loadCurrentFile();
            updateFileNavigation();
            updateFilesOverview();
            showAnalysisPreview();
        }
    }

    // Function to go to next file
    function goToNextFile() {
        console.log('Going to next file:', currentFileIndex);
        if (currentFileIndex < selectedFiles.length - 1) {
            currentFileIndex++;
            loadCurrentFile();
            updateFileNavigation();
            updateFilesOverview();
            showAnalysisPreview();
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // PDF handling functions
    function loadPDF(file) {
        console.log('Loading PDF file:', file.name);
        
        if (!pdfjsLib) {
            console.error('PDF.js library not loaded');
            showToast('PDF.js library not loaded. Please refresh the page.', 'error', 5000);
            return;
        }
        
        const fileReader = new FileReader();
        fileReader.onload = function(e) {
            try {
                console.log('File read successfully, starting PDF parsing...');
                const typedArray = new Uint8Array(e.target.result);
                
                pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
                    console.log('PDF document loaded successfully, pages:', pdf.numPages);
                    
                    pdfDoc = pdf;
                    pageNum = 1;
                    pageRendering = false;
                    pageNumPending = null;
                    scale = 1.0;
                    
                    // Show PDF container and controls
                    pdfPlaceholder.classList.add('hidden');
                    pdfContainer.classList.remove('hidden');
                    pdfControls.classList.remove('hidden');
                    
                    console.log('PDF container shown, rendering first page...');
                    
                    // Render first page
                    renderPage(pageNum);
                    
                    // Update page info
                    updatePageInfo();
                    updateZoomInfo();
                    
                    // Show success toast for PDF preview
                    showToast('PDF preview ready! You can navigate and zoom.', 'success', 4000);
                }).catch(function(error) {
                    console.error('Error loading PDF document:', error);
                    showPDFError();
                    showToast('Failed to load PDF. Please try a different file.', 'error', 5000);
                });
            } catch (error) {
                console.error('Error processing PDF file:', error);
                showPDFError();
                showToast('Error processing PDF file. Please try again.', 'error', 5000);
            }
        };
        
        fileReader.onerror = function(error) {
            console.error('Error reading file:', error);
            showToast('Error reading file. Please try again.', 'error', 5000);
        };
        
        fileReader.readAsArrayBuffer(file);
    }

    function renderPage(num) {
        pageRendering = true;
        pdfDoc.getPage(num).then(function(page) {
            const viewport = page.getViewport({ scale: scale });
            const canvas = document.getElementById('pdfCanvas');
            const context = canvas.getContext('2d');
            
            // Set canvas size
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            // Clear canvas
            context.clearRect(0, 0, canvas.width, canvas.height);
            
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            
            const renderTask = page.render(renderContext);
            renderTask.promise.then(function() {
                pageRendering = false;
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            }).catch(function(error) {
                console.error('Error rendering page:', error);
                pageRendering = false;
            });
        });
    }

    function showPDFError() {
        pdfPlaceholder.innerHTML = `
            <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-2"></i>
            <p class="text-sm text-red-500">Error loading PDF</p>
            <p class="text-xs text-red-400 mt-1">Please try a different file</p>
        `;
        pdfPlaceholder.classList.remove('hidden');
        pdfContainer.classList.add('hidden');
        pdfControls.classList.add('hidden');
    }

    function showAnalysisPreview() {
        const currentFile = selectedFiles[currentFileIndex];
        const analysisPreview = document.getElementById('analysisPreview');
        
        if (!currentFile || !analysisPreview) {
            if (analysisPreview) analysisPreview.classList.add('hidden');
            return;
        }
        
        analysisPreview.classList.remove('hidden');
        
        // Check if we already have analysis results for this file
        const result = filesAnalysisResults[currentFile.name];
        if (result && result.success) {
            // Show existing analysis results
            displayAnalysisResults(result.data);
        } else if (result && !result.success) {
            // Show error
            displayAnalysisError(result.error);
        } else {
            // Show pending state
            if (analysisPreview) {
                analysisPreview.innerHTML = `
                <div class="space-y-3">
                    <div class="text-center py-4">
                        <i class="fas fa-clock text-gray-400 text-2xl mb-2"></i>
                        <p class="text-sm text-gray-600">Analysis Pending</p>
                        <p class="text-xs text-gray-500 mt-1">This file is waiting to be analyzed</p>
                    </div>
                </div>
            `;
            }
        }
    }

    async function analyzePDFWithAI() {
        if (selectedFiles.length === 0) {
            console.log('No files selected');
            return;
        }
        
        const file = selectedFiles[currentFileIndex];
        
        if (!file) {
            console.log('No current file');
            return;
        }
        
        console.log('Starting PDF analysis for file:', file.name);
        
        try {
            // Extract text from PDF
            console.log('Extracting text from PDF...');
            const pdfText = await extractTextFromPDF(file);
            console.log('PDF text extracted, length:', pdfText.length);
            
            // Send to AI for analysis
            console.log('Sending to AI for analysis...');
            const response = await fetch('/api/analyze-cv-preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({ text: pdfText })
            });
            
            console.log('AI response status:', response.status);
            const result = await response.json();
            console.log('AI response:', result);
            
            if (result.success) {
                displayAnalysisResults(result.data);
            } else {
                displayAnalysisError(result.error);
            }
        } catch (error) {
            console.error('Error analyzing PDF:', error);
            displayAnalysisError('Failed to analyze CV. Please try again.');
        }
    }

    async function extractTextFromPDF(file) {
        return new Promise((resolve, reject) => {
            console.log('Starting PDF text extraction...');
            
            if (!pdfjsLib) {
                reject(new Error('PDF.js library not loaded'));
                return;
            }
            
            const fileReader = new FileReader();
            fileReader.onload = function(e) {
                try {
                    const typedArray = new Uint8Array(e.target.result);
                    console.log('PDF file loaded, starting document parsing...');
                    
                    pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
                        console.log('PDF document loaded, pages:', pdf.numPages);
                        let fullText = '';
                        let pageCount = 0;
                        
                        function extractPageText(pageNum) {
                            if (pageNum > pdf.numPages) {
                                console.log('PDF text extraction completed, total length:', fullText.length);
                                resolve(fullText);
                                return;
                            }
                            
                            pdf.getPage(pageNum).then(function(page) {
                                page.getTextContent().then(function(textContent) {
                                    const pageText = textContent.items.map(item => item.str).join(' ');
                                    fullText += pageText + '\n';
                                    pageCount++;
                                    
                                    console.log(`Extracted page ${pageNum}/${pdf.numPages}`);
                                    
                                    if (pageCount < pdf.numPages) {
                                        extractPageText(pageNum + 1);
                                    } else {
                                        console.log('PDF text extraction completed, total length:', fullText.length);
                                        resolve(fullText);
                                    }
                                }).catch(function(error) {
                                    console.error('Error extracting text from page:', error);
                                    reject(error);
                                });
                            }).catch(function(error) {
                                console.error('Error getting page:', error);
                                reject(error);
                            });
                        }
                        
                        extractPageText(1);
                    }).catch(function(error) {
                        console.error('Error loading PDF document:', error);
                        reject(error);
                    });
                } catch (error) {
                    console.error('Error processing PDF file:', error);
                    reject(error);
                }
            };
            
            fileReader.onerror = function(error) {
                console.error('Error reading file:', error);
                reject(error);
            };
            
            fileReader.readAsArrayBuffer(file);
        });
    }

    function displayAnalysisResults(data) {
        // Clear progress interval
        if (window.progressInterval) {
            clearInterval(window.progressInterval);
            window.progressInterval = null;
        }
        
        // Store analysis result
        const currentFile = selectedFiles[currentFileIndex];
        filesAnalysisResults[currentFile.name] = {
            success: true,
            data: data
        };
        
        const analysisPreview = document.getElementById('analysisPreview');
        if (analysisPreview) analysisPreview.classList.remove('hidden');
        
        const hasPersonalInfo = data.name && data.email && data.phone;
        const hasEducation = data.education && data.education.trim().length > 0;
        const hasExperience = data.experience && data.experience.trim().length > 0;
        const hasSkills = data.skills && data.skills.trim().length > 0;
        if (analysisPreview) {
            analysisPreview.innerHTML = `
            <div class="space-y-3">
                <div class="space-y-2">
                    <div class="flex items-center text-sm">
                        <i class="fas fa-user text-gray-400 mr-2"></i>
                        <span class="text-gray-600">Personal Information</span>
                        ${hasPersonalInfo ? '<i class="fas fa-check text-green-500 ml-auto"></i>' : '<i class="fas fa-times text-red-500 ml-auto"></i>'}
                    </div>
                    <div class="flex items-center text-sm">
                        <i class="fas fa-graduation-cap text-gray-400 mr-2"></i>
                        <span class="text-gray-600">Education</span>
                        ${hasEducation ? '<i class="fas fa-check text-green-500 ml-auto"></i>' : '<i class="fas fa-times text-red-500 ml-auto"></i>'}
                    </div>
                    <div class="flex items-center text-sm">
                        <i class="fas fa-briefcase text-gray-400 mr-2"></i>
                        <span class="text-gray-600">Work Experience</span>
                        ${hasExperience ? '<i class="fas fa-check text-green-500 ml-auto"></i>' : '<i class="fas fa-times text-red-500 ml-auto"></i>'}
                    </div>
                    <div class="flex items-center text-sm">
                        <i class="fas fa-cogs text-gray-400 mr-2"></i>
                        <span class="text-gray-600">Skills</span>
                        ${hasSkills ? '<i class="fas fa-check text-green-500 ml-auto"></i>' : '<i class="fas fa-times text-red-500 ml-auto"></i>'}
                    </div>
                </div>
                
                ${hasPersonalInfo || hasEducation || hasExperience || hasSkills ? `
                <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span class="text-sm text-green-700 font-medium">CV Analysis Complete</span>
                    </div>
                    <p class="text-xs text-green-600 mt-1">AI has successfully analyzed your CV</p>
                </div>
                ` : `
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                        <span class="text-sm text-yellow-700 font-medium">Limited Information Found</span>
                    </div>
                    <p class="text-xs text-yellow-600 mt-1">Some sections may need more detail</p>
                </div>
                `}
            </div>
        `;
        }
    }

    function displayAnalysisError(error) {
        // Clear progress interval
        if (window.progressInterval) {
            clearInterval(window.progressInterval);
            window.progressInterval = null;
        }
        
        // Store error result
        const currentFile = selectedFiles[currentFileIndex];
        filesAnalysisResults[currentFile.name] = {
            success: false,
            error: error
        };
        
        const analysisPreview = document.getElementById('analysisPreview');
        if (analysisPreview) analysisPreview.classList.remove('hidden');
        if (analysisPreview) {
            analysisPreview.innerHTML = `
            <div class="space-y-3">
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-circle text-red-500 text-2xl mb-2"></i>
                    <p class="text-sm text-red-600">Analysis Failed</p>
                    <p class="text-xs text-red-500 mt-1">${error}</p>
                </div>
            </div>
        `;
        }
    }

    function resetAnalysisPreview() {
        // Clear progress interval
        if (window.progressInterval) {
            clearInterval(window.progressInterval);
            window.progressInterval = null;
        }
        
        const analysisPreview = document.getElementById('analysisPreview');
        if (analysisPreview) {
            analysisPreview.classList.add('hidden');
            if (analysisPreview) analysisPreview.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-brain text-gray-300 text-4xl mb-3"></i>
                <p class="text-sm text-gray-500">AI analysis will appear here after upload</p>
            </div>
        `;
        }
    }

    async function analyzeAllFiles() {
        console.log('Starting analysis for all files:', selectedFiles.length);
        
        // Show analysis preview for first file immediately
        if (selectedFiles.length > 0) {
            showAnalysisPreview();
        }
        
        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            console.log(`Analyzing file ${i + 1}/${selectedFiles.length}:`, file.name);
            
            try {
                // Extract text from PDF
                const pdfText = await extractTextFromPDF(file);
                console.log(`PDF text extracted for ${file.name}, length:`, pdfText.length);
                
                // Send to AI for analysis
                const response = await fetch('/api/analyze-cv-preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
                    },
                    body: JSON.stringify({ text: pdfText })
                });
                
                const result = await response.json();
                console.log(`AI response for ${file.name}:`, result);
                
                if (result.success) {
                    filesAnalysisResults[file.name] = {
                        success: true,
                        data: result.data
                    };
                } else {
                    filesAnalysisResults[file.name] = {
                        success: false,
                        error: result.error
                    };
                }
                
                // Update analysis preview for current file if it's the one being analyzed
                if (i === currentFileIndex) {
                    showAnalysisPreview();
                }
                
                
                
            } catch (error) {
                console.error(`Error analyzing ${file.name}:`, error);
                filesAnalysisResults[file.name] = {
                    success: false,
                    error: 'Failed to analyze CV. Please try again.'
                };
                
                // Update analysis preview for current file if it's the one being analyzed
                if (i === currentFileIndex) {
                    showAnalysisPreview();
                }
            }
        }
        
        console.log('All files analysis completed');
        
        // Update overview once after all analysis is done
        updateFilesOverview();
        
        // Show analysis preview for current file after all analysis is done
        if (selectedFiles.length > 0) {
            showAnalysisPreview();
        }
        
    }

    function updateFilesOverview() {
        if (selectedFiles.length <= 1) {
            if (filesOverview) filesOverview.classList.add('hidden');
            return;
        }
        
        if (filesOverview) filesOverview.classList.remove('hidden');
        if (filesOverviewList) filesOverviewList.innerHTML = '';
        
        selectedFiles.forEach((file, index) => {
            const result = filesAnalysisResults[file.name];
            const isAnalyzed = result && result.success;
            const isCurrent = index === currentFileIndex;
            
            let statusIcon = 'fas fa-clock text-gray-400';
            let statusText = 'Pending';
            let statusColor = 'bg-gray-100 text-gray-600';
            
            if (isAnalyzed) {
                const hasPersonalInfo = result.data.name && result.data.email && result.data.phone;
                const hasEducation = result.data.education && result.data.education.trim().length > 0;
                const hasExperience = result.data.experience && result.data.experience.trim().length > 0;
                const hasSkills = result.data.skills && result.data.skills.trim().length > 0;
                
                const completedSections = [hasPersonalInfo, hasEducation, hasExperience, hasSkills].filter(Boolean).length;
                
                if (completedSections >= 3) {
                    statusIcon = 'fas fa-check-circle text-green-500';
                    statusText = 'Complete';
                    statusColor = 'bg-green-100 text-green-700';
                } else if (completedSections >= 2) {
                    statusIcon = 'fas fa-exclamation-triangle text-yellow-500';
                    statusText = 'Partial';
                    statusColor = 'bg-yellow-100 text-yellow-700';
                } else {
                    statusIcon = 'fas fa-times-circle text-red-500';
                    statusText = 'Incomplete';
                    statusColor = 'bg-red-100 text-red-700';
                }
            }
            
            const fileItem = document.createElement('div');
            fileItem.className = `flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-colors ${isCurrent ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:bg-gray-50'}`;
            fileItem.onclick = () => {
                currentFileIndex = index;
                loadCurrentFile();
                updateFileNavigation();
                updateFilesOverview();
                showAnalysisPreview();
            };
            
            fileItem.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-file-pdf text-red-500 mr-3"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900">${file.name}</p>
                        <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor} mr-2">
                        <i class="${statusIcon} mr-1"></i>
                        ${statusText}
                    </span>
                    <button onclick="event.stopPropagation(); showFileDetails(${index})" class="text-gray-400 hover:text-gray-600 ml-2">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    ${isCurrent ? '<i class="fas fa-arrow-right text-blue-500 ml-2"></i>' : ''}
                </div>
            `;
            
            if (filesOverviewList) filesOverviewList.appendChild(fileItem);
        });
    }

    function showFileDetails(fileIndex) {
        const file = selectedFiles[fileIndex];
        const result = filesAnalysisResults[file.name];
        
        if (!result || !result.success) {
            return;
        }
        
        const data = result.data;
        const hasPersonalInfo = data.name && data.email && data.phone;
        const hasEducation = data.education && data.education.trim().length > 0;
        const hasExperience = data.experience && data.experience.trim().length > 0;
        const hasSkills = data.skills && data.skills.trim().length > 0;
        
        const completedSections = [hasPersonalInfo, hasEducation, hasExperience, hasSkills].filter(Boolean).length;
        
        let statusText = '';
        let statusColor = '';
        
        if (completedSections >= 3) {
            statusText = 'Complete';
            statusColor = 'text-green-600';
        } else if (completedSections >= 2) {
            statusText = 'Partial';
            statusColor = 'text-yellow-600';
        } else {
            statusText = 'Incomplete';
            statusColor = 'text-red-600';
        }
        
        const detailsHtml = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-gray-900">Chi tiết phân tích: ${file.name}</h3>
                            <button onclick="closeFileDetails()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                                <i class="fas fa-${completedSections >= 3 ? 'check-circle' : completedSections >= 2 ? 'exclamation-triangle' : 'times-circle'} mr-2"></i>
                                ${statusText} (${completedSections}/4 sections)
                            </span>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-user text-gray-400 mr-3"></i>
                                    <span class="text-sm font-medium text-gray-700">Personal Information</span>
                                </div>
                                <div class="flex items-center">
                                    ${hasPersonalInfo ? 
                                        '<i class="fas fa-check text-green-500 mr-2"></i><span class="text-sm text-green-600">Complete</span>' : 
                                        '<i class="fas fa-times text-red-500 mr-2"></i><span class="text-sm text-red-600">Missing</span>'
                                    }
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-graduation-cap text-gray-400 mr-3"></i>
                                    <span class="text-sm font-medium text-gray-700">Education</span>
                                </div>
                                <div class="flex items-center">
                                    ${hasEducation ? 
                                        '<i class="fas fa-check text-green-500 mr-2"></i><span class="text-sm text-green-600">Complete</span>' : 
                                        '<i class="fas fa-times text-red-500 mr-2"></i><span class="text-sm text-red-600">Missing</span>'
                                    }
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-briefcase text-gray-400 mr-3"></i>
                                    <span class="text-sm font-medium text-gray-700">Work Experience</span>
                                </div>
                                <div class="flex items-center">
                                    ${hasExperience ? 
                                        '<i class="fas fa-check text-green-500 mr-2"></i><span class="text-sm text-green-600">Complete</span>' : 
                                        '<i class="fas fa-times text-red-500 mr-2"></i><span class="text-sm text-red-600">Missing</span>'
                                    }
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-cogs text-gray-400 mr-3"></i>
                                    <span class="text-sm font-medium text-gray-700">Skills</span>
                                </div>
                                <div class="flex items-center">
                                    ${hasSkills ? 
                                        '<i class="fas fa-check text-green-500 mr-2"></i><span class="text-sm text-green-600">Complete</span>' : 
                                        '<i class="fas fa-times text-red-500 mr-2"></i><span class="text-sm text-red-600">Missing</span>'
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-sm text-blue-700">
                                <i class="fas fa-info-circle mr-2"></i>
                                File này có ${completedSections} trong 4 tiêu chí cần thiết. 
                                ${completedSections >= 3 ? 'File đạt yêu cầu tốt!' : completedSections >= 2 ? 'File cần cải thiện thêm một số thông tin.' : 'File cần bổ sung nhiều thông tin hơn.'}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', detailsHtml);
    }
    
    function closeFileDetails() {
        const modal = document.querySelector('.fixed.inset-0');
        if (modal) {
            modal.remove();
        }
    }

    // File navigation controls
    prevFile.addEventListener('click', goToPreviousFile);
    nextFile.addEventListener('click', goToNextFile);

    // PDF controls
    prevPage.addEventListener('click', function() {
        if (pageNum <= 1 || pageRendering) return;
        pageNum--;
        renderPage(pageNum);
        updatePageInfo();
    });

    nextPage.addEventListener('click', function() {
        if (pageNum >= pdfDoc.numPages || pageRendering) return;
        pageNum++;
        renderPage(pageNum);
        updatePageInfo();
    });

    zoomIn.addEventListener('click', function() {
        if (scale >= 3.0 || pageRendering) return;
        scale += 0.25;
        renderPage(pageNum);
        updateZoomInfo();
    });

    zoomOut.addEventListener('click', function() {
        if (scale <= 0.5 || pageRendering) return;
        scale -= 0.25;
        renderPage(pageNum);
        updateZoomInfo();
    });

    function updatePageInfo() {
        if (pdfDoc) {
            pageInfo.textContent = `Page ${pageNum} of ${pdfDoc.numPages}`;
            prevPage.disabled = pageNum <= 1;
            nextPage.disabled = pageNum >= pdfDoc.numPages;
        }
    }

    function updateZoomInfo() {
        zoomLevel.textContent = `${Math.round(scale * 100)}%`;
        zoomOut.disabled = scale <= 0.5;
        zoomIn.disabled = scale >= 3.0;
    }

    // Form submission with loading state
    document.getElementById('cvForm').addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        const fileCount = fileInput.files.length;
        
        if (fileCount === 1) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing CV...';
            showToast('Processing CV with AI... This may take a moment.', 'info', 5000);
        } else {
            submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing ${fileCount} CVs...`;
            showToast(`Processing ${fileCount} CVs with AI... This may take a moment.`, 'info', 5000);
        }
        
        submitBtn.disabled = true;
});
</script>
{% endblock %}
