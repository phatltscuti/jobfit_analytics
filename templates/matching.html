{% extends "layouts/base.html" %}

{% block title %}Job Matching - JobFit Analytics{% endblock %}

{% block content %}
<style>
    /* Custom loading animations */
    @keyframes pulse-glow {
        0%, 100% { 
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        50% { 
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.6);
        }
    }
    
    @keyframes fade-in-up {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .loading-overlay-enter {
        animation: fade-in-up 0.3s ease-out;
    }
    
    .loading-spinner-glow {
        animation: pulse-glow 2s ease-in-out infinite;
    }
    
    .loading-dots {
        animation: wave 1.4s ease-in-out infinite both;
    }
    
    .loading-dots:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots:nth-child(2) { animation-delay: -0.16s; }
    .loading-dots:nth-child(3) { animation-delay: 0s; }
    
    @keyframes wave {
        0%, 60%, 100% {
            transform: translateY(0) scale(1);
            opacity: 0.6;
        }
        30% {
            transform: translateY(-25px) scale(1.3);
            opacity: 1;
        }
    }
    
    /* Alternative wave effect for more dots */
    .loading-dots-wave {
        animation: wave-smooth 1.6s ease-in-out infinite both;
    }
    
    .loading-dots-wave:nth-child(1) { animation-delay: 0s; }
    .loading-dots-wave:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots-wave:nth-child(3) { animation-delay: 0.4s; }
    .loading-dots-wave:nth-child(4) { animation-delay: 0.6s; }
    .loading-dots-wave:nth-child(5) { animation-delay: 0.8s; }
    
    @keyframes wave-smooth {
        0%, 80%, 100% {
            transform: translateY(0) scale(1);
            opacity: 0.5;
        }
        40% {
            transform: translateY(-30px) scale(1.4);
            opacity: 1;
        }
    }
</style>

<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                Job Matching
            </h2>
            <p class="mt-1 text-sm text-gray-500">
                AI-powered matching between CVs and job postings
            </p>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                <i class="fas fa-robot mr-2"></i>AI-Powered Analysis
            </span>
        </div>
    </div>

    <!-- Selection Form -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <form method="POST" class="space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Job Selection -->
                    <div>
                        <label for="job_id" class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center"><i class="fas fa-briefcase mr-2 text-gray-500"></i>Select Job</span>
                        </label>
                        <div class="relative mb-2">
                            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                            <input id="jobFilter" type="text" placeholder="Filter jobs by title or company..."
                                   class="w-full pl-10 pr-4 py-2 border-2 border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 sm:text-sm bg-white" />
                        </div>
                        <select name="job_id" id="job_id" required 
                                class="mt-1 block w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 sm:text-sm bg-white">
                            <option value="">Choose a job to match</option>
                            {% for job in jobs %}
                                <option value="{{ job.id }}" {% if selected_job and selected_job.id == job.id %}selected{% endif %}>
                                    {{ job.title }} - {{ job.company }}
                                </option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-2">Newest jobs appear first. Start typing to jump to an option.</p>
                        {% if selected_job %}
                        <div class="mt-4 p-4 bg-green-50 rounded-xl border border-green-200">
                            <h4 class="text-sm font-medium text-green-900 mb-2">Selected Job</h4>
                            <div class="text-sm text-green-700">
                                <p><strong>Title:</strong> {{ selected_job.title }}</p>
                                <p><strong>Company:</strong> {{ selected_job.company }}</p>
                                <p><strong>Location:</strong> {{ selected_job.location }}</p>
                                {% if selected_job.salary_min or selected_job.salary_max %}
                                    <p><strong>Salary:</strong>
                                        {% if selected_job.salary_min and selected_job.salary_max %}
                                            ${{ '%.0f'|format(selected_job.salary_min) }} - ${{ '%.0f'|format(selected_job.salary_max) }}
                                        {% elif selected_job.salary_min %}
                                            From ${{ '%.0f'|format(selected_job.salary_min) }}
                                        {% elif selected_job.salary_max %}
                                            Up to ${{ '%.0f'|format(selected_job.salary_max) }}
                                        {% endif %}
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Multi CV Selection -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label for="cv_ids" class="block text-sm font-medium text-gray-700">
                                <span class="inline-flex items-center"><i class="fas fa-id-card mr-2 text-gray-500"></i>Select CVs (multiple)</span>
                            </label>
                            <span id="cvSelectedCount" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700">0 selected</span>
                        </div>
                        <div class="relative mb-2">
                            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                            <input id="cvFilter" type="text" placeholder="Filter CVs by name or email..."
                                   class="w-full pl-10 pr-4 py-2 border-2 border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 sm:text-sm bg-white" />
                        </div>
                        <select name="cv_ids" id="cv_ids" multiple size="10"
                                class="mt-1 block w-full px-3 py-2 border-2 border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 sm:text-sm bg-white h-64">
                            {% for cv in cvs %}
                                <option value="{{ cv.id }}" {% if selected_cv_ids and (cv.id in selected_cv_ids) %}selected{% endif %}>
                                    {{ cv.name or 'Unknown' }} - {{ cv.email or 'No email' }}
                                </option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-2">Hold Ctrl (Cmd on Mac) to select multiple CVs</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                    <!-- Criteria Styled Card -->
                    <div>
                        <label for="criteria" class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center"><i class="fas fa-sliders-h mr-2 text-gray-500"></i>Matching Criteria (optional)</span>
                        </label>
                        <div class="relative">
                            <textarea id="criteria" name="criteria" rows="4" maxlength="600"
                                      placeholder="E.g., prioritize React + TypeScript, ≥3 years experience, English B2+, fintech domain..."
                                      class="w-full pr-14 pl-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 sm:text-sm bg-white">{{ criteria or '' }}</textarea>
                            <div class="absolute right-3 bottom-3 text-xs text-gray-400" id="criteriaCounter">0 / 600</div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">These criteria will be appended to the AI prompt and influence the match scoring.</p>
                    </div>

                    <!-- Threshold Styled Control -->
                    <div class="w-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center"><i class="fas fa-percent mr-2 text-gray-500"></i>Pass threshold</span>
                        </label>
                        <div class="p-4 border-2 border-gray-200 rounded-xl bg-white shadow-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500">Min: 0</span>
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-primary-50 text-primary-700" id="thresholdBadge">{{ pass_threshold }}%</span>
                                <span class="text-xs text-gray-500">Max: 100</span>
                            </div>
                            <input type="range" id="pass_threshold_range" min="0" max="100" value="{{ pass_threshold }}" step="1"
                                   class="mt-3 w-full accent-primary-600" />
                            <div class="mt-3 flex items-center space-x-3">
                                <input type="number" name="pass_threshold" id="pass_threshold_input" min="0" max="100" value="{{ pass_threshold }}"
                                       class="w-24 px-3 py-2 border-2 border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm" />
                                <button type="submit" class="ml-auto bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg text-sm font-medium transition-all duration-200 hover:shadow-md transform hover:scale-105 active:scale-95">
                                    <i class="fas fa-search mr-2"></i>Analyze Matching
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Spinner -->
    {% if is_analyzing %}
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6 text-center">
            <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-primary-500 hover:bg-primary-400 transition ease-in-out duration-150 cursor-not-allowed">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Analyzing match with AI...
            </div>
            <p class="mt-4 text-sm text-gray-500">This may take a few moments</p>
        </div>
    </div>
    {% endif %}

    <!-- Match Results -->
    {% if match_results and selected_job %}
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Kết quả Matching cho: <span class="font-semibold">{{ selected_job.title }}</span></h3>
            <!-- Debug info -->
            <div class="mb-4 p-3 bg-gray-100 rounded text-sm">
                <strong>Debug:</strong> 
                Match results count: {{ match_results|length }}, 
                Selected job: {{ selected_job.title if selected_job else 'None' }}
                {% if match_results %}
                <br><strong>First result:</strong> 
                CV: {{ match_results[0].cv.name }}, 
                Score: {{ match_results[0].match_score }}, 
                Strengths: {{ match_results[0].strengths|length }}, 
                Analysis: {{ match_results[0].analysis[:100] if match_results[0].analysis else 'None' }}...
                {% endif %}
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CV</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Điểm</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kết quả</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Điểm mạnh</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Điểm yếu</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chi tiết</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for r in match_results %}
                        <tr>
                            <td class="px-4 py-3 text-sm text-gray-900">
                                <a href="{{ url_for('cvs_show', cv_id=r.cv.id) }}" class="text-primary-600 hover:underline">{{ r.cv.name or 'Unknown' }}</a>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-500">{{ r.cv.email or '-' }}</td>
                            <td class="px-4 py-3 text-sm">
                                <span class="font-semibold {{ 'text-green-600' if r.match_score >= pass_threshold else 'text-yellow-600' }}">{{ r.match_score }}%</span>
                            </td>
                            <td class="px-4 py-3">
                                {% if r.pass %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Đạt</span>
                                {% else %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Không đạt</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-xs text-gray-600">
                                {% if r.strengths and r.strengths|length > 0 %}
                                    <ul class="list-disc list-inside space-y-1">
                                        {% for s in r.strengths[:3] %}<li>{{ s }}</li>{% endfor %}
                                    </ul>
                                {% else %}
                                    <span class="text-red-500">No data ({{ r.strengths|length }})</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-xs text-gray-600">
                                {% if r.weaknesses and r.weaknesses|length > 0 %}
                                    <ul class="list-disc list-inside space-y-1">
                                        {% for w in r.weaknesses[:3] %}<li>{{ w }}</li>{% endfor %}
                                    </ul>
                                {% else %}
                                    <span class="text-red-500">No data ({{ r.weaknesses|length }})</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <button type="button" class="px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-medium"
                                        onclick="openMatchModal({{ r.cv.id }})">
                                    Xem chi tiết
                                </button>
                                <script type="application/json" id="match-detail-{{ r.cv.id }}">
                                    {
                                        "score": {{ r.match_score | int }},
                                        "analysis": {{ (r.analysis or '') | tojson }},
                                        "strengths": {{ r.strengths | default([]) | tojson }},
                                        "weaknesses": {{ r.weaknesses | default([]) | tojson }},
                                        "recommendations": {{ r.recommendations | default([]) | tojson }},
                                        "criteria": {{ r.criteria_breakdown | default([]) | tojson }}
                                    }
                                </script>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <!-- No Results Message -->
    {% if request.method == 'POST' %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-yellow-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-yellow-800">Không có kết quả matching</h3>
                <div class="mt-2 text-sm text-yellow-700">
                    <p>Vui lòng kiểm tra:</p>
                    <ul class="list-disc list-inside mt-1 space-y-1">
                        <li>Đã chọn job và ít nhất 1 CV</li>
                        <li>CV có dữ liệu đầy đủ</li>
                        <li>API OpenAI hoạt động bình thường</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- AI Analysis Info -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-robot text-blue-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">AI-Powered Matching</h3>
                <div class="mt-2 text-sm text-blue-700">
                    <p>Our AI analyzes the compatibility between CVs and job postings by examining:</p>
                    <ul class="list-disc list-inside mt-1 space-y-1">
                        <li>Skills alignment and requirements match</li>
                        <li>Experience level compatibility</li>
                        <li>Education and qualifications</li>
                        <li>Location and work preferences</li>
                        <li>Overall profile fit</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Enhance selects: filter CVs and show selected count
    (function() {
        const jobSelect = document.getElementById('job_id');
        const cvsSelect = document.getElementById('cv_ids');
        const cvFilter = document.getElementById('cvFilter');
        const jobFilter = document.getElementById('jobFilter');
        const cvSelectedCount = document.getElementById('cvSelectedCount');
        const criteria = document.getElementById('criteria');
        const criteriaCounter = document.getElementById('criteriaCounter');
        const thresholdRange = document.getElementById('pass_threshold_range');
        const thresholdInput = document.getElementById('pass_threshold_input');
        const thresholdBadge = document.getElementById('thresholdBadge');

        function updateSelectedCount() {
            if (!cvsSelect || !cvSelectedCount) return;
            const count = Array.from(cvsSelect.selectedOptions).length;
            cvSelectedCount.textContent = `${count} selected`;
        }

        function filterOptions() {
            if (!cvsSelect || !cvFilter) return;
            const term = cvFilter.value.toLowerCase();
            Array.from(cvsSelect.options).forEach(opt => {
                const txt = opt.textContent.toLowerCase();
                opt.hidden = term && !txt.includes(term);
            });
        }

        if (cvsSelect) {
            cvsSelect.addEventListener('change', updateSelectedCount);
            updateSelectedCount();
        }
        if (cvFilter) {
            cvFilter.addEventListener('input', filterOptions);
        }

        if (jobFilter && jobSelect) {
            jobFilter.addEventListener('input', function() {
                const term = jobFilter.value.toLowerCase();
                Array.from(jobSelect.options).forEach(opt => {
                    const txt = opt.textContent.toLowerCase();
                    opt.hidden = term && !txt.includes(term);
                });
            });
        }

        // Criteria counter
        if (criteria && criteriaCounter) {
            const updateCount = () => {
                const len = criteria.value.length;
                criteriaCounter.textContent = `${len} / 600`;
            };
            criteria.addEventListener('input', updateCount);
            updateCount();
        }

        // Threshold sync (range <-> number) + badge
        function syncThreshold(fromRange) {
            if (!thresholdBadge) return;
            if (fromRange && thresholdRange && thresholdInput) {
                thresholdInput.value = thresholdRange.value;
            } else if (thresholdInput && thresholdRange) {
                let v = parseInt(thresholdInput.value || '0', 10);
                if (isNaN(v)) v = 0;
                v = Math.min(100, Math.max(0, v));
                thresholdInput.value = v;
                thresholdRange.value = String(v);
            }
            thresholdBadge.textContent = `${thresholdInput ? thresholdInput.value : (thresholdRange ? thresholdRange.value : 0)}%`;
        }
        if (thresholdRange) thresholdRange.addEventListener('input', () => syncThreshold(true));
        if (thresholdInput) thresholdInput.addEventListener('input', () => syncThreshold(false));
        syncThreshold(true);

        // Optional: auto-submit when job changes and at least one CV selected
        if (jobSelect && cvsSelect) {
            jobSelect.addEventListener('change', function() {
                if (this.value && cvsSelect.selectedOptions.length > 0) {
                    this.form.submit();
                }
            });
        }
    })();
</script>

<!-- Modal -->
<div id="matchModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" onclick="closeMatchModal()"></div>
    <div class="relative z-10 max-w-3xl mx-auto mt-16 bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="px-6 py-4 border-b flex items-center justify-between">
            <h4 class="text-base font-semibold text-gray-900">Chi tiết kết quả matching</h4>
            <button class="text-gray-500 hover:text-gray-700" onclick="closeMatchModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-6 space-y-6 max-h-[70vh] overflow-auto" id="matchModalBody"></div>
        <div class="px-6 py-4 border-t flex justify-end">
            <button class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm" onclick="closeMatchModal()">Đóng</button>
        </div>
    </div>
</div>

<script>
    function openMatchModal(cvId) {
        const container = document.getElementById(`match-detail-${cvId}`);
        if (!container) return;
        let raw = container.textContent || container.innerText || '';
        let data = {};
        try { data = JSON.parse(raw.trim()); } catch (e) { data = {}; }
        const body = document.getElementById('matchModalBody');
        const score = typeof data.score === 'number' ? data.score : '-';
        const analysis = data.analysis || '';
        const strengths = Array.isArray(data.strengths) ? data.strengths : [];
        const weaknesses = Array.isArray(data.weaknesses) ? data.weaknesses : [];
        const recommendations = Array.isArray(data.recommendations) ? data.recommendations : [];
        const criteria = Array.isArray(data.criteria) ? data.criteria : [];

        let html = '';
        html += `<div class="flex items-center gap-3">`+
                `<span class="text-sm text-gray-600">Tổng điểm:</span>`+
                `<span class="text-lg font-semibold ${score>=70?'text-green-600':(score>=50?'text-yellow-600':'text-red-600')}">${score}%</span>`+
                `</div>`;
        if (analysis) {
            html += `<div><h5 class="text-sm font-medium text-gray-900 mb-2">Nhận xét tổng quan</h5>`+
                    `<p class="text-sm text-gray-700 whitespace-pre-line">${escapeHtml(analysis)}</p></div>`;
        }
        if (criteria.length) {
            html += `<div><h5 class="text-sm font-medium text-gray-900 mb-2">Bảng 15 tiêu chí</h5>`+
                    `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 text-sm">`+
                    `<thead class="bg-gray-50"><tr>`+
                    `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tiêu chí</th>`+
                    `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Điểm (%)</th>`+
                    `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Trọng số</th>`+
                    `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Điểm quy đổi</th>`+
                    `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Giải thích</th>`+
                    `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            criteria.forEach(row => {
                html += `<tr>`+
                        `<td class="px-3 py-2 text-gray-900">${escapeHtml(row.criterion||'')}</td>`+
                        `<td class="px-3 py-2">${row.score ?? '-'}</td>`+
                        `<td class="px-3 py-2">${row.weight ?? '-'}</td>`+
                        `<td class="px-3 py-2">${row.weighted_score ?? '-'}</td>`+
                        `<td class="px-3 py-2 text-gray-600">${escapeHtml(row.explain||'')}</td>`+
                        `</tr>`;
            });
            html += `</tbody></table></div></div>`;
        }
        if (strengths.length) {
            html += `<div><h5 class="text-sm font-medium text-gray-900 mb-2">Điểm mạnh</h5><ul class="list-disc list-inside text-sm text-gray-700 space-y-1">`+
                    strengths.map(s=>`<li>${escapeHtml(s)}</li>`).join('')+
                    `</ul></div>`;
        }
        if (weaknesses.length) {
            html += `<div><h5 class="text-sm font-medium text-gray-900 mb-2">Khoảng trống</h5><ul class="list-disc list-inside text-sm text-gray-700 space-y-1">`+
                    weaknesses.map(w=>`<li>${escapeHtml(w)}</li>`).join('')+
                    `</ul></div>`;
        }
        if (recommendations.length) {
            html += `<div><h5 class="text-sm font-medium text-gray-900 mb-2">Khuyến nghị</h5><ul class="list-disc list-inside text-sm text-gray-700 space-y-1">`+
                    recommendations.map(r=>`<li>${escapeHtml(r)}</li>`).join('')+
                    `</ul></div>`;
        }

        body.innerHTML = html || '<p class="text-sm text-gray-600">Không có dữ liệu chi tiết.</p>';
        document.getElementById('matchModal').classList.remove('hidden');
    }
    function closeMatchModal(){
        document.getElementById('matchModal').classList.add('hidden');
    }
    function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, function (m) {
            return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]);
        });
    }

    // Loading indicator for form submission
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form[method="POST"]');
        const submitBtn = form.querySelector('button[type="submit"]');
        
        if (form && submitBtn) {
            form.addEventListener('submit', function() {
                // Show loading state on button
                submitBtn.disabled = true;
                submitBtn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Analyzing...
                `;
                submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
            });
        }
    });

</script>
{% endblock %}