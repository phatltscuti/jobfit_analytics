{% extends "layouts/base.html" %}

{% block title %}Job Matching - JobFit Analytics{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                Job Matching
            </h2>
            <p class="mt-1 text-sm text-gray-500">
                AI-powered matching between CVs and job postings
            </p>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                <i class="fas fa-robot mr-2"></i>AI-Powered Analysis
            </span>
        </div>
    </div>

    <!-- Selection Form -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <form method="POST" class="space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Job Selection -->
                    <div>
                        <label for="job_id" class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center"><i class="fas fa-briefcase mr-2 text-gray-500"></i>Select Job</span>
                        </label>
                        <div class="relative mb-2">
                            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                            <input id="jobFilter" type="text" placeholder="Filter jobs by title or company..."
                                   class="w-full pl-10 pr-4 py-2 border-2 border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 sm:text-sm bg-white" />
                        </div>
                        <select name="job_id" id="job_id" required 
                                class="mt-1 block w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 sm:text-sm bg-white">
                            <option value="">Choose a job to match</option>
                            {% for job in jobs %}
                                <option value="{{ job.id }}" {% if selected_job and selected_job.id == job.id %}selected{% endif %}>
                                    {{ job.title }} - {{ job.company }}
                                </option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-2">Newest jobs appear first. Start typing to jump to an option.</p>
                        {% if selected_job %}
                        <div class="mt-4 p-4 bg-green-50 rounded-xl border border-green-200">
                            <h4 class="text-sm font-medium text-green-900 mb-2">Selected Job</h4>
                            <div class="text-sm text-green-700">
                                <p><strong>Title:</strong> {{ selected_job.title }}</p>
                                <p><strong>Company:</strong> {{ selected_job.company }}</p>
                                <p><strong>Location:</strong> {{ selected_job.location }}</p>
                                {% if selected_job.salary_min or selected_job.salary_max %}
                                    <p><strong>Salary:</strong>
                                        {% if selected_job.salary_min and selected_job.salary_max %}
                                            ${{ '%.0f'|format(selected_job.salary_min) }} - ${{ '%.0f'|format(selected_job.salary_max) }}
                                        {% elif selected_job.salary_min %}
                                            From ${{ '%.0f'|format(selected_job.salary_min) }}
                                        {% elif selected_job.salary_max %}
                                            Up to ${{ '%.0f'|format(selected_job.salary_max) }}
                                        {% endif %}
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Multi CV Selection -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label for="cv_ids" class="block text-sm font-medium text-gray-700">
                                <span class="inline-flex items-center"><i class="fas fa-id-card mr-2 text-gray-500"></i>Select CVs (multiple)</span>
                            </label>
                            <span id="cvSelectedCount" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700">0 selected</span>
                        </div>
                        <div class="relative mb-2">
                            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                            <input id="cvFilter" type="text" placeholder="Filter CVs by name or email..."
                                   class="w-full pl-10 pr-4 py-2 border-2 border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 sm:text-sm bg-white" />
                        </div>
                        <select name="cv_ids" id="cv_ids" multiple size="10"
                                class="mt-1 block w-full px-3 py-2 border-2 border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 sm:text-sm bg-white h-64">
                            {% for cv in cvs %}
                                <option value="{{ cv.id }}" {% if selected_cv_ids and (cv.id in selected_cv_ids) %}selected{% endif %}>
                                    {{ cv.name or 'Unknown' }} - {{ cv.email or 'No email' }}
                                </option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-2">Hold Ctrl (Cmd on Mac) to select multiple CVs</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                    <!-- Criteria Styled Card -->
                    <div>
                        <label for="criteria" class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center"><i class="fas fa-sliders-h mr-2 text-gray-500"></i>Matching Criteria (optional)</span>
                        </label>
                        <div class="relative">
                            <textarea id="criteria" name="criteria" rows="4" maxlength="600"
                                      placeholder="E.g., prioritize React + TypeScript, ≥3 years experience, English B2+, fintech domain..."
                                      class="w-full pr-14 pl-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 sm:text-sm bg-white">{{ criteria or '' }}</textarea>
                            <div class="absolute right-3 bottom-3 text-xs text-gray-400" id="criteriaCounter">0 / 600</div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">These criteria will be appended to the AI prompt and influence the match scoring.</p>
                    </div>

                    <!-- Threshold Styled Control -->
                    <div class="w-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center"><i class="fas fa-percent mr-2 text-gray-500"></i>Pass threshold</span>
                        </label>
                        <div class="p-4 border-2 border-gray-200 rounded-xl bg-white shadow-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500">Min: 0</span>
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-primary-50 text-primary-700" id="thresholdBadge">{{ pass_threshold }}%</span>
                                <span class="text-xs text-gray-500">Max: 100</span>
                            </div>
                            <input type="range" id="pass_threshold_range" min="0" max="100" value="{{ pass_threshold }}" step="1"
                                   class="mt-3 w-full accent-primary-600" />
                            <div class="mt-3 flex items-center space-x-3">
                                <input type="number" name="pass_threshold" id="pass_threshold_input" min="0" max="100" value="{{ pass_threshold }}"
                                       class="w-24 px-3 py-2 border-2 border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm" />
                                <button type="submit" class="ml-auto bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg text-sm font-medium transition-colors">
                                    <i class="fas fa-search mr-2"></i>Analyze Matching
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Spinner -->
    {% if is_analyzing %}
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6 text-center">
            <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-primary-500 hover:bg-primary-400 transition ease-in-out duration-150 cursor-not-allowed">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Analyzing match with AI...
            </div>
            <p class="mt-4 text-sm text-gray-500">This may take a few moments</p>
        </div>
    </div>
    {% endif %}

    <!-- Match Results -->
    {% if match_results and selected_job %}
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Kết quả Matching cho: <span class="font-semibold">{{ selected_job.title }}</span></h3>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CV</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Điểm</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kết quả</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Điểm mạnh</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khoảng trống</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for r in match_results %}
                        <tr>
                            <td class="px-4 py-3 text-sm text-gray-900">
                                <a href="{{ url_for('cvs_show', cv_id=r.cv.id) }}" class="text-primary-600 hover:underline">{{ r.cv.name or 'Unknown' }}</a>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-500">{{ r.cv.email or '-' }}</td>
                            <td class="px-4 py-3 text-sm">
                                <span class="font-semibold {{ 'text-green-600' if r.match_score >= pass_threshold else 'text-yellow-600' }}">{{ r.match_score }}%</span>
                            </td>
                            <td class="px-4 py-3">
                                {% if r.pass %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Đạt</span>
                                {% else %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Không đạt</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-xs text-gray-600">
                                {% if r.strengths %}
                                    <ul class="list-disc list-inside space-y-1">
                                        {% for s in r.strengths[:3] %}<li>{{ s }}</li>{% endfor %}
                                    </ul>
                                {% else %}-{% endif %}
                            </td>
                            <td class="px-4 py-3 text-xs text-gray-600">
                                {% if r.weaknesses %}
                                    <ul class="list-disc list-inside space-y-1">
                                        {% for w in r.weaknesses[:3] %}<li>{{ w }}</li>{% endfor %}
                                    </ul>
                                {% else %}-{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- AI Analysis Info -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-robot text-blue-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">AI-Powered Matching</h3>
                <div class="mt-2 text-sm text-blue-700">
                    <p>Our AI analyzes the compatibility between CVs and job postings by examining:</p>
                    <ul class="list-disc list-inside mt-1 space-y-1">
                        <li>Skills alignment and requirements match</li>
                        <li>Experience level compatibility</li>
                        <li>Education and qualifications</li>
                        <li>Location and work preferences</li>
                        <li>Overall profile fit</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Enhance selects: filter CVs and show selected count
    (function() {
        const jobSelect = document.getElementById('job_id');
        const cvsSelect = document.getElementById('cv_ids');
        const cvFilter = document.getElementById('cvFilter');
        const jobFilter = document.getElementById('jobFilter');
        const cvSelectedCount = document.getElementById('cvSelectedCount');
        const criteria = document.getElementById('criteria');
        const criteriaCounter = document.getElementById('criteriaCounter');
        const thresholdRange = document.getElementById('pass_threshold_range');
        const thresholdInput = document.getElementById('pass_threshold_input');
        const thresholdBadge = document.getElementById('thresholdBadge');

        function updateSelectedCount() {
            if (!cvsSelect || !cvSelectedCount) return;
            const count = Array.from(cvsSelect.selectedOptions).length;
            cvSelectedCount.textContent = `${count} selected`;
        }

        function filterOptions() {
            if (!cvsSelect || !cvFilter) return;
            const term = cvFilter.value.toLowerCase();
            Array.from(cvsSelect.options).forEach(opt => {
                const txt = opt.textContent.toLowerCase();
                opt.hidden = term && !txt.includes(term);
            });
        }

        if (cvsSelect) {
            cvsSelect.addEventListener('change', updateSelectedCount);
            updateSelectedCount();
        }
        if (cvFilter) {
            cvFilter.addEventListener('input', filterOptions);
        }

        if (jobFilter && jobSelect) {
            jobFilter.addEventListener('input', function() {
                const term = jobFilter.value.toLowerCase();
                Array.from(jobSelect.options).forEach(opt => {
                    const txt = opt.textContent.toLowerCase();
                    opt.hidden = term && !txt.includes(term);
                });
            });
        }

        // Criteria counter
        if (criteria && criteriaCounter) {
            const updateCount = () => {
                const len = criteria.value.length;
                criteriaCounter.textContent = `${len} / 600`;
            };
            criteria.addEventListener('input', updateCount);
            updateCount();
        }

        // Threshold sync (range <-> number) + badge
        function syncThreshold(fromRange) {
            if (!thresholdBadge) return;
            if (fromRange && thresholdRange && thresholdInput) {
                thresholdInput.value = thresholdRange.value;
            } else if (thresholdInput && thresholdRange) {
                let v = parseInt(thresholdInput.value || '0', 10);
                if (isNaN(v)) v = 0;
                v = Math.min(100, Math.max(0, v));
                thresholdInput.value = v;
                thresholdRange.value = String(v);
            }
            thresholdBadge.textContent = `${thresholdInput ? thresholdInput.value : (thresholdRange ? thresholdRange.value : 0)}%`;
        }
        if (thresholdRange) thresholdRange.addEventListener('input', () => syncThreshold(true));
        if (thresholdInput) thresholdInput.addEventListener('input', () => syncThreshold(false));
        syncThreshold(true);

        // Optional: auto-submit when job changes and at least one CV selected
        if (jobSelect && cvsSelect) {
            jobSelect.addEventListener('change', function() {
                if (this.value && cvsSelect.selectedOptions.length > 0) {
                    this.form.submit();
                }
            });
        }
    })();
</script>
{% endblock %}